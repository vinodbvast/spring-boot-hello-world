pipeline {
    agent any
    stages {
        stage('Checkout') {
            steps {
                script {
                    // Checkout the code from the Git repository
                    checkout([$class: 'GitSCM', 
                      branches: [[name: 'dev']],
                      userRemoteConfigs: [[
                        credentialsId: 'vinodbvast',
                        url: 'https://github.com/vinodbvast/spring-boot-hello-world.git'
                      ]]
                    ])
                }
            }
        }
        stage('Configure Git') {
            steps {
                script {
                    // Change to the workspace directory
                    dir('/home/lab001/.jenkins/workspace/Dev/Tag_and_notify_failure') {
                        // Configure Git user email and name
                        sh "git config user.email 'vinodb@valueaddsofttech.com'"
                        sh "git config user.name 'vinodbvast'"
                    }
                }
            }
        }
        stage('Build') {
            steps {
                // Build the project using Maven
                sh 'mvn clean package' 
            }
        }
        stage('Tag Artifact') {
            when {
                expression { currentBuild.resultIsBetterOrEqualTo('SUCCESS') }
            }
            steps {
                script {
                    def version = "${BUILD_NUMBER}"
                    withCredentials([gitUsernamePassword(credentialsId: 'vinodbvast')]) {
                        // Tag and push the artifact to the Git repository
                        sh "git tag -a v${version} -m 'Tagging for build ${version}'"
                        sh "git push origin v${version}"
                    }
                }
            }
        }
    }
    post {
        always {
            // Archive the built JAR file as an artifact
            archiveArtifacts artifacts: '**/target/*.jar', allowEmptyArchive: true
        }
        success {
            emailext (
                to: 'vinodb@valueaddsofttech.com',
                subject: "Build Succeeded for ${currentBuild.fullDisplayName}",
                body: "The build succeeded."
            )
        }
        failure {
            emailext (
                to: 'vinodb@valueaddsofttech.com',
                subject: "Build Failed for ${currentBuild.fullDisplayName}",
                body: "The build failed. Please investigate."
            )
        }
    }
}
