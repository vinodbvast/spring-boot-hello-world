pipeline {
    agent any
    stages {
        stage('Checkout') {
            steps {
                script {
                    // Checkout the code from the Git repository
                    checkout([$class: 'GitSCM', 
                      branches: [[name: 'dev']],
                      userRemoteConfigs: [[
                        credentialsId: 'vinodbvast',
                        url: 'https://github.com/vinodbvast/spring-boot-hello-world.git'
                      ]]
                    ])
                }
            }
        }
        stage('Configure Git') {
            steps {
                script {
                    dir('/home/lab001/.jenkins/workspace/Dev/Tag_and_notify_failure') {
                        sh "git config user.email 'vinodb@valueaddsofttech.com'"
                        sh "git config user.name 'vinodbvast'"
                    }
                }
            }
        }
        stage('Build') {
            steps {
                sh 'mvn clean package' 
            }
        }
        stage('Tag Artifact') {
            when {
                expression { currentBuild.resultIsBetterOrEqualTo('SUCCESS') }
            }
            steps {
                script {
                    def version = "${BUILD_NUMBER}"
                    def jarFileName = "spring-boot-2-hello-world-${version}.jar"
                    def tagMessage = "Tagging for build ${version}"

                    withCredentials([gitUsernamePassword(credentialsId: 'vinodbvast')]) {
                        sh "git tag -a v${version} -m '${tagMessage}'"
                        sh "git push origin v${version}"

                        // Rename the JAR file with the version and archive it
                        sh "mv target/spring-boot-2-hello-world-1.0.2-SNAPSHOT.jar target/${jarFileName}"
                        archiveArtifacts artifacts: "target/${jarFileName}", allowEmptyArchive: true
                    }
                }
            }
        }
    }
    post {
        always {
            // Archive the original JAR file as well
            archiveArtifacts artifacts: '**/target/spring-boot-2-hello-world-1.0.2-SNAPSHOT.jar', allowEmptyArchive: true
        }
        success {
            emailext (
                to: 'vinodb@valueaddsofttech.com',
                subject: "Build Succeeded for ${currentBuild.fullDisplayName}",
                body: "The build succeeded."
            )
        }
        failure {
            emailext (
                to: 'vinodb@valueaddsofttech.com',
                subject: "Build Failed for ${currentBuild.fullDisplayName}",
                body: "The build failed. Please investigate."
            )
        }
    }
}
